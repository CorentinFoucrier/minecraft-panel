#!/usr/bin/env php
<?php declare(strict_types=1);
if (php_sapi_name() != "cli") {
    fwrite(
        STDERR,
        PHP_EOL."File only in CLI".PHP_EOL
    );
    die(1);
}
require_once '/var/www/vendor/autoload.php';
$dbname = getenv('MYSQL_DATABASE');
$dbuser = getenv('MYSQL_USER');
$dbpassword = getenv('MYSQL_PASSWORD');
$dbhost = getenv('MYSQL_HOST');
$NUM_OF_ATTEMPTS = 10;
$attempts = 0;
do {
    try
    {
        $pdo = new PDO("mysql:host=$dbhost;dbname=$dbname", $dbuser, $dbpassword);
    } catch (Exception $e) {
        $attempts++;
        sleep(3);
        continue;
    }
    break;
} while ($attempts < $NUM_OF_ATTEMPTS);
$prefix = getenv('PREFIX');
echo "Creating Database".PHP_EOL;
sleep(1);
echo "[||";
$pdo->exec("DROP TABLE `".$prefix."server`");
$pdo->exec("DROP TABLE `".$prefix."user`");
$pdo->exec("DROP TABLE `".$prefix."role`");
echo "||";
$pdo->exec("CREATE TABLE `".$prefix."server` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT,
    `name` varchar(255) NOT NULL,
    `panel_port` smallint(3) UNSIGNED NOT NULL,
    `is_installed` tinyint(1) UNSIGNED NOT NULL,
    `status` tinyint(1) UNSIGNED NOT NULL DEFAULT 0,
    `version` varchar(255) NOT NULL,
    PRIMARY KEY(`id`)
)");
echo "||";
$pdo->exec("CREATE TABLE `".$prefix."user` (
    `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT,
    `username` varchar(255) NOT NULL,
    `password` varchar(255) NOT NULL,
    `role_id` tinyint(1) UNSIGNED NOT NULL,
    PRIMARY KEY(`id`)
)");
echo "||";
$pdo->exec("CREATE TABLE `".$prefix."role` (
    `id` tinyint(1) UNSIGNED NOT NULL AUTO_INCREMENT,
    `role_name` varchar(255) NOT NULL DEFAULT 2,
    PRIMARY KEY(`id`)
)");
echo "||||";
$pdo->exec('SET FOREIGN_KEY_CHECKS = 0');
$pdo->exec("TRUNCATE TABLE `server`");
$pdo->exec("TRUNCATE TABLE `user`");
$pdo->exec("TRUNCATE TABLE `role`");
$pdo->exec('SET FOREIGN_KEY_CHECKS = 1');
echo "||]".PHP_EOL;
echo "Instert default value to the database".PHP_EOL;
sleep(1);
echo "[||";
// Check what is the last minecraft version
$json = file_get_contents('https://pastebin.com/raw/LVdci0Ck');
$versions = json_decode($json, true);
$version = array_key_first($versions['vanilla']['stable']);
$pdo->exec("INSERT INTO `{$prefix}server` (
    `name`, `panel_port`, `is_installed`, `status`, `version`
) VALUES (
    'Minecraft Panel', 8080, 0, 0, 'MC_{$version}'
)");
echo "||||";
$pdo->exec("INSERT INTO `{$prefix}role` (
    `role_name`
) VALUES 
    ('admin'),
    ('co-admin'),
    ('moderator')
");
echo "||||";
$passwordHash = password_hash('admin', PASSWORD_ARGON2ID);
$pdo->exec("INSERT INTO `{$prefix}user` (
    `username`, `password`, `role_id`
) VALUES (
    'admin', '{$passwordHash}', 1
)");
echo "||]".PHP_EOL;